# pip install requests pandas numpy beautifulsoup4 slack-sdk schedule
import requests
import pandas as pd
import numpy as np
from bs4 import BeautifulSoup
import re
import os
from datetime import datetime, timedelta
import json
from slack_sdk import WebClient
from slack_sdk.errors import SlackApiError
from config import SLACK_WEBHOOK_URL, DATA_DIR, FINVIZ_URL

# 1) Finviz ì›¹ ìŠ¤í¬ë˜í•‘ìœ¼ë¡œ ì§ì ‘ ë°ì´í„° ìˆ˜ì§‘
def scrape_finviz_screener():
    url = FINVIZ_URL
    
    headers = {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
    }
    
    print("Finviz ì›¹ í˜ì´ì§€ì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...")
    response = requests.get(url, headers=headers)
    response.raise_for_status()
    
    soup = BeautifulSoup(response.content, 'html.parser')
    
    # í…Œì´ë¸” ì°¾ê¸° (ì—¬ëŸ¬ ê°€ëŠ¥í•œ í´ë˜ìŠ¤ëª… ì‹œë„)
    table = None
    possible_classes = ['table-light', 'screener_table', 'table', 'screener']
    
    for class_name in possible_classes:
        table = soup.find('table', {'class': class_name})
        if table:
            print(f"í…Œì´ë¸”ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤: {class_name}")
            break
    
    if not table:
        # í´ë˜ìŠ¤ëª… ì—†ì´ í…Œì´ë¸” ì°¾ê¸°
        tables = soup.find_all('table')
        print(f"ì´ {len(tables)}ê°œì˜ í…Œì´ë¸”ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤.")
        
        # ê°€ì¥ í° í…Œì´ë¸” ì„ íƒ (ë°ì´í„°ê°€ ë§ì€ í…Œì´ë¸”)
        if tables:
            table = max(tables, key=lambda t: len(t.find_all('tr')))
            print("ê°€ì¥ í° í…Œì´ë¸”ì„ ì„ íƒí–ˆìŠµë‹ˆë‹¤.")
        else:
            print("í…Œì´ë¸”ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
            return None
    
    # í—¤ë” ì¶”ì¶œ
    headers = []
    rows = table.find_all('tr')
    print(f"ì´ {len(rows)}ê°œì˜ í–‰ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤.")
    
    # ì²« ë²ˆì§¸ í–‰ì´ í—¤ë”ì¸ì§€ í™•ì¸
    if len(rows) > 0:
        first_row = rows[0]
        cells = first_row.find_all(['td', 'th'])
        print(f"ì²« ë²ˆì§¸ í–‰ì˜ ì…€ ìˆ˜: {len(cells)}")
        
        for cell in cells:
            text = cell.get_text().strip()
            headers.append(text)
            print(f"í—¤ë” ì…€: '{text}'")
    
    print(f"ì»¬ëŸ¼ í—¤ë”: {headers}")
    
    # í—¤ë”ê°€ ë¹„ì–´ìˆìœ¼ë©´ ê¸°ë³¸ í—¤ë” ì‚¬ìš©
    if not headers or all(h == '' for h in headers):
        print("í—¤ë”ê°€ ë¹„ì–´ìˆì–´ì„œ ê¸°ë³¸ í—¤ë”ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.")
        headers = ['Ticker', 'Company', 'Sector', 'Industry', 'Country', 'Market Cap', 'P/E', 'Price', 'Change', 'Volume', 'Performance (Quarter)', 'Performance (Month)', 'Performance (Week)', 'Performance (Half Year)', 'Performance (Year)', 'Performance (3 Years)', 'Performance (5 Years)', 'Performance (10 Years)']
    
    # ë°ì´í„° ì¶”ì¶œ
    data = []
    data_rows = rows[1:] if len(rows) > 1 else rows  # í—¤ë”ê°€ ìˆìœ¼ë©´ ì œì™¸, ì—†ìœ¼ë©´ ëª¨ë“  í–‰ ì‚¬ìš©
    
    for row in data_rows:
        cells = row.find_all('td')
        if len(cells) > 0:
            row_data = []
            for cell in cells:
                text = cell.get_text().strip()
                # ë§í¬ê°€ ìˆëŠ” ê²½ìš° (í‹°ì»¤) ë§í¬ í…ìŠ¤íŠ¸ ì‚¬ìš©
                link = cell.find('a')
                if link:
                    text = link.get_text().strip()
                row_data.append(text)
            data.append(row_data)
    
    # DataFrame ìƒì„±
    df = pd.DataFrame(data, columns=headers)
    print(f"ì´ {len(df)}ê°œ ì¢…ëª©ì„ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.")
    
    return df

# 2) ë°ì´í„° ì €ì¥ í•¨ìˆ˜
def save_daily_data(df, date_str):
    """ì¼ì¼ ë°ì´í„°ë¥¼ CSV íŒŒì¼ë¡œ ì €ì¥"""
    if not os.path.exists(DATA_DIR):
        os.makedirs(DATA_DIR)
    
    filename = f"{DATA_DIR}/finviz_data_{date_str}.csv"
    df.to_csv(filename, index=False)
    print(f"ë°ì´í„°ë¥¼ {filename}ì— ì €ì¥í–ˆìŠµë‹ˆë‹¤.")
    return filename

# 3) ì´ì „ ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
def load_previous_data(days_ago):
    """ì§€ì •ëœ ì¼ìˆ˜ ì „ì˜ ë°ì´í„°ë¥¼ ë¡œë“œ"""
    target_date = (datetime.now() - timedelta(days=days_ago)).strftime("%Y-%m-%d")
    filename = f"{DATA_DIR}/finviz_data_{target_date}.csv"
    
    if os.path.exists(filename):
        return pd.read_csv(filename)
    else:
        print(f"{days_ago}ì¼ ì „ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {filename}")
        return None

# 4) ë°ì´í„° ë¹„êµ ë¶„ì„ í•¨ìˆ˜
def compare_data(current_df, previous_df, period_name):
    """í˜„ì¬ ë°ì´í„°ì™€ ì´ì „ ë°ì´í„°ë¥¼ ë¹„êµ"""
    if previous_df is None:
        return f"{period_name}: ë¹„êµí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."
    
    current_top10 = current_df.head(10)
    previous_top10 = previous_df.head(10)
    
    # ìƒˆë¡œìš´ ì¢…ëª©ë“¤ (ì´ì „ì— ì—†ì—ˆë˜ ì¢…ëª©)
    current_tickers = set(current_top10['Ticker'])
    previous_tickers = set(previous_top10['Ticker'])
    new_tickers = current_tickers - previous_tickers
    dropped_tickers = previous_tickers - current_tickers
    
    # ìˆœìœ„ ë³€í™” ë¶„ì„
    rank_changes = []
    for ticker in current_tickers & previous_tickers:
        current_rank = current_top10[current_top10['Ticker'] == ticker].index[0] + 1
        previous_rank = previous_top10[previous_top10['Ticker'] == ticker].index[0] + 1
        change = previous_rank - current_rank  # ì–‘ìˆ˜ë©´ ìƒìŠ¹, ìŒìˆ˜ë©´ í•˜ë½
        rank_changes.append({
            'ticker': ticker,
            'current_rank': current_rank,
            'previous_rank': previous_rank,
            'change': change
        })
    
    # ìƒìœ„ 3ê°œ ì¢…ëª©ì˜ ìˆ˜ìµë¥  ë³€í™”
    top3_changes = []
    for i in range(min(3, len(current_top10), len(previous_top10))):
        current_ticker = current_top10.iloc[i]['Ticker']
        current_perf = current_top10.iloc[i]['Perf Quart']
        
        if current_ticker in previous_tickers:
            prev_row = previous_top10[previous_top10['Ticker'] == current_ticker]
            if not prev_row.empty:
                previous_perf = prev_row.iloc[0]['Perf Quart']
                perf_change = float(current_perf.replace('%', '')) - float(previous_perf.replace('%', ''))
                top3_changes.append({
                    'ticker': current_ticker,
                    'current_perf': current_perf,
                    'previous_perf': previous_perf,
                    'perf_change': perf_change
                })
    
    return {
        'period': period_name,
        'new_tickers': list(new_tickers),
        'dropped_tickers': list(dropped_tickers),
        'rank_changes': rank_changes,
        'top3_changes': top3_changes
    }

# 5) Slack ë©”ì‹œì§€ ìƒì„± í•¨ìˆ˜
def create_slack_message(current_df, yesterday_analysis, week_analysis):
    """Slack ë©”ì‹œì§€ ìƒì„±"""
    current_top10 = current_df.head(10)
    
    message = f"ğŸ“ˆ *Finviz ëŒ€í˜•ì£¼ 3ê°œì›” ìˆ˜ìµë¥  ìƒìœ„ 10ê°œ - {datetime.now().strftime('%Y-%m-%d')}*\n\n"
    
    # í˜„ì¬ ìƒìœ„ 10ê°œ
    message += "*ğŸ† í˜„ì¬ ìƒìœ„ 10ê°œ ì¢…ëª©:*\n"
    for i, row in current_top10.iterrows():
        message += f"{i+1}. {row['Ticker']} - {row['Perf Quart']} (${row['Price']})\n"
    
    # ì „ë‚  ë¹„êµ
    if yesterday_analysis:
        message += f"\n*ğŸ“Š ì „ë‚  ëŒ€ë¹„ ë³€í™”:*\n"
        if yesterday_analysis['new_tickers']:
            message += f"â€¢ ìƒˆë¡œ ì§„ì…: {', '.join(yesterday_analysis['new_tickers'])}\n"
        if yesterday_analysis['dropped_tickers']:
            message += f"â€¢ íƒˆë½: {', '.join(yesterday_analysis['dropped_tickers'])}\n"
        
        if yesterday_analysis['top3_changes']:
            message += f"â€¢ ìƒìœ„ 3ê°œ ìˆ˜ìµë¥  ë³€í™”:\n"
            for change in yesterday_analysis['top3_changes']:
                change_str = f"+{change['perf_change']:.1f}%" if change['perf_change'] > 0 else f"{change['perf_change']:.1f}%"
                message += f"  - {change['ticker']}: {change['previous_perf']} â†’ {change['current_perf']} ({change_str})\n"
    
    # ì¼ì£¼ì¼ ì „ ë¹„êµ
    if week_analysis:
        message += f"\n*ğŸ“… ì¼ì£¼ì¼ ì „ ëŒ€ë¹„ ë³€í™”:*\n"
        if week_analysis['new_tickers']:
            message += f"â€¢ ìƒˆë¡œ ì§„ì…: {', '.join(week_analysis['new_tickers'])}\n"
        if week_analysis['dropped_tickers']:
            message += f"â€¢ íƒˆë½: {', '.join(week_analysis['dropped_tickers'])}\n"
    
    return message

# 6) Slack ì „ì†¡ í•¨ìˆ˜
def send_to_slack(message, webhook_url):
    """Slackìœ¼ë¡œ ë©”ì‹œì§€ ì „ì†¡"""
    try:
        response = requests.post(webhook_url, json={'text': message})
        if response.status_code == 200:
            print("Slack ë©”ì‹œì§€ ì „ì†¡ ì„±ê³µ!")
        else:
            print(f"Slack ì „ì†¡ ì‹¤íŒ¨: {response.status_code}")
    except Exception as e:
        print(f"Slack ì „ì†¡ ì¤‘ ì˜¤ë¥˜: {e}")

# 7) ë©”ì¸ ì‹¤í–‰ í•¨ìˆ˜
def main():
    
    # í˜„ì¬ ë‚ ì§œ
    today = datetime.now().strftime("%Y-%m-%d")
    
    print(f"=== Finviz ëŒ€í˜•ì£¼ 3ê°œì›” ìˆ˜ìµë¥  ë¶„ì„ - {today} ===")
    
    # 1) ë°ì´í„° ìˆ˜ì§‘
    df = scrape_finviz_screener()
    if df is None:
        print("ë°ì´í„° ìˆ˜ì§‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")
        return
    
    print("ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.")
    
    # 2) í˜„ì¬ ë°ì´í„° ì €ì¥
    save_daily_data(df, today)
    
    # 3) ì´ì „ ë°ì´í„° ë¡œë“œ ë° ë¹„êµ
    yesterday_df = load_previous_data(1)  # 1ì¼ ì „
    week_ago_df = load_previous_data(7)  # 7ì¼ ì „
    
    # 4) ë¹„êµ ë¶„ì„
    yesterday_analysis = None
    week_analysis = None
    
    if yesterday_df is not None:
        yesterday_analysis = compare_data(df, yesterday_df, "ì „ë‚ ")
        print("ì „ë‚  ëŒ€ë¹„ ë¶„ì„ ì™„ë£Œ")
    
    if week_ago_df is not None:
        week_analysis = compare_data(df, week_ago_df, "ì¼ì£¼ì¼ ì „")
        print("ì¼ì£¼ì¼ ì „ ëŒ€ë¹„ ë¶„ì„ ì™„ë£Œ")
    
    # 5) í˜„ì¬ ìƒìœ„ 10ê°œ ì¶œë ¥
    print(f"\n=== 3ê°œì›” ìˆ˜ìµë¥  ìƒìœ„ 10ê°œ ì¢…ëª© ===")
    top10 = df.head(10)[['Ticker', 'Perf Quart', 'Price', 'Change']]
    print(top10)
    
    # 6) Slack ë©”ì‹œì§€ ìƒì„± ë° ì „ì†¡
    if SLACK_WEBHOOK_URL != "YOUR_SLACK_WEBHOOK_URL_HERE":
        slack_message = create_slack_message(df, yesterday_analysis, week_analysis)
        send_to_slack(slack_message, SLACK_WEBHOOK_URL)
    else:
        print("\nSlack ì›¹í›… URLì„ ì„¤ì •í•´ì£¼ì„¸ìš”.")
        print("ìƒì„±ëœ ë©”ì‹œì§€ ë¯¸ë¦¬ë³´ê¸°:")
        print(create_slack_message(df, yesterday_analysis, week_analysis))

# 8) ì‹¤í–‰
if __name__ == "__main__":
    main()
