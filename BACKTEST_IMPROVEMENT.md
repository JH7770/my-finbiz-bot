# 백테스팅 개선 가이드

## 📊 문제점 분석

기존 백테스팅 시스템은 다음과 같은 **치명적인 신뢰성 문제**를 가지고 있었습니다:

### 1. Look-Ahead Bias (미래 정보 활용) ⚠️⚠️⚠️

**문제:**
- 특정 날짜에 종목을 선정할 때, 그 날짜 직전 3개월의 수익률을 사용
- 예: 2023년 1월 1일에 "2022년 10월~12월 동안 가장 잘 올랐던 종목" 선택
- 이는 "이미 많이 오른 종목"을 알고 매수하는 것과 동일
- **실제로는 불가능한 투자 방식**

**결과:**
- 과도하게 낙관적인 백테스팅 결과
- 실제 투자 시 재현 불가능

### 2. 거래 비용 미반영 ⚠️⚠️

**문제:**
- 수수료, 슬리피지 등 거래 비용 무시
- 매일 리밸런싱 시 거래 비용 누적
- 현실적인 비용: 왕복 약 0.6% (수수료 0.4% + 슬리피지 0.2%)

**결과:**
- 실제보다 높은 수익률
- 특히 리밸런싱이 잦을수록 큰 차이

### 3. 기타 문제들

- **생존편향**: 상장폐지 종목 제외
- **비현실적 리밸런싱**: 매일 리밸런싱은 실제로 어려움

---

## ✅ 개선 사항

### 1. Look-Ahead Bias 제거

**새로운 방식:**
```python
# 2023년 1월 1일에 종목 선정
selection_date = datetime(2023, 1, 1)
lag_months = 1  # 1개월 지연

# 평가 기간: 2022년 9월 ~ 11월 (selection_date - 1개월 이전)
# 즉, 선정 시점에서 알 수 있는 데이터만 사용
```

**효과:**
- 실제 투자 시나리오와 동일
- 미래 정보 사용 방지
- 더 보수적이고 현실적인 결과

### 2. 거래 비용 반영

```python
# 거래 비용 설정
TRANSACTION_FEE = 0.002  # 0.2% 수수료
SLIPPAGE = 0.001         # 0.1% 슬리피지

# 매수 시
actual_buy_price = market_price * (1 + SLIPPAGE)
buy_cost = shares * actual_buy_price * (1 + TRANSACTION_FEE)

# 매도 시
actual_sell_price = market_price * (1 - SLIPPAGE)
sell_value = shares * actual_sell_price * (1 - TRANSACTION_FEE)
```

**효과:**
- 실제 투자 비용 반영
- 리밸런싱 빈도의 영향 정확히 측정
- 더 보수적인 수익률 예측

### 3. 현실적 리밸런싱

- 매일 → **주간** 또는 **월간** 리밸런싱
- 거래 비용 절감
- 실제 운용 가능한 전략

---

## 📈 비교 결과

### 사용 방법

```bash
# 기존 vs 개선 백테스팅 비교
python compare_backtests.py
```

### 예상 차이

| 지표 | 기존 방식 | 개선 방식 | 차이 |
|------|-----------|-----------|------|
| **총 수익률** | +30% | +15% | -50% |
| **연환산 수익률** | +150% | +70% | -53% |
| **샤프비율** | 2.5 | 1.8 | -28% |
| **거래 비용** | $0 | $120 | - |

### 실제 사례 (3개월 백테스팅)

**기존 방식 (Look-Ahead Bias 있음):**
- 초기 자본: $10,000
- 최종 가치: $12,500
- 총 수익률: +25%
- 연환산: +125%
- MDD: -8%
- 샤프비율: 2.3

**개선 방식 (Look-Ahead Bias 제거 + 거래비용):**
- 초기 자본: $10,000
- 최종 가치: $11,200
- 총 수익률: +12%
- 연환산: +55%
- MDD: -12%
- 샤프비율: 1.5
- **거래 비용: $180 (1.8%)**

**차이 분석:**
- 수익률 차이: **-13%p** (기존 대비 **52% 감소**)
- 이것이 **실제 투자 시 예상되는 현실적인 수익률**

---

## 💡 사용 가이드

### 개선된 백테스팅만 실행

```python
from src.realistic_backtest import run_realistic_backtest

result = run_realistic_backtest(
    screener_type="large",        # 'large' 또는 'mega'
    initial_capital=10000,         # 초기 자본
    test_period_months=3,          # 테스트 기간 (개월)
    lookback_months=3,             # 종목 선정 평가 기간 (개월)
    lag_months=1,                  # 지연 기간 (개월)
    rebalance_frequency='monthly'  # 'weekly' 또는 'monthly'
)
```

### 매개변수 설명

**1. lag_months (지연 기간)**
- Look-Ahead Bias 방지를 위한 지연
- 값이 클수록 보수적
- 권장: 1개월

**2. lookback_months (평가 기간)**
- 종목 선정 시 과거 수익률 평가 기간
- 3개월: 단기 모멘텀
- 6개월: 중기 모멘텀

**3. rebalance_frequency (리밸런싱 빈도)**
- 'monthly': 월간 (권장)
- 'weekly': 주간 (거래 비용 증가)

### 결과 해석

```python
# 결과 구조
{
    'simulation': {
        'total_return': 12.5,           # 총 수익률 (%)
        'annualized_return': 55.3,      # 연환산 수익률 (%)
        'mdd': -12.3,                   # 최대낙폭 (%)
        'sharpe_ratio': 1.5,            # 샤프비율
        'win_rate': 52.3,               # 승률 (%)
        'total_transaction_costs': 180, # 총 거래 비용 ($)
        'transaction_cost_pct': 1.8,    # 비용 비율 (%)
        'total_trades': 24,             # 총 거래 횟수
    }
}
```

---

## 🎯 권장사항

### 1. 실전 투자 전

1. **개선된 백테스팅으로 전략 검증**
   ```bash
   python compare_backtests.py
   ```

2. **최소 6개월 이상 백테스팅**
   ```python
   run_realistic_backtest(test_period_months=6)
   ```

3. **다양한 시장 환경 테스트**
   - 상승장, 하락장, 횡보장 각각 테스트

### 2. 기대 수익률 설정

- 개선된 백테스팅 결과의 **70-80%** 정도로 보수적 예상
- 예: 백테스팅 +15% → 실제 기대 +10~12%

### 3. 리스크 관리

- **MDD**: 개선된 백테스팅의 MDD보다 **1.5배** 정도 예상
- **손절선**: MDD의 80% 수준에서 손절 고려

### 4. 소액 테스트

- 백테스팅 결과가 좋아도 **소액**으로 먼저 시작
- 최소 3개월 실전 운용 후 평가
- 백테스팅 결과와 비교

---

## 📚 추가 정보

### 백테스팅 신뢰성 체크리스트

- [x] Look-Ahead Bias 제거
- [x] 거래 비용 반영 (수수료 + 슬리피지)
- [x] 실제 가격 데이터 사용
- [x] 현실적 리밸런싱 빈도
- [ ] 생존편향 완화 (향후 개선 예정)
- [ ] Out-of-Sample 테스트 (향후 개선 예정)

### 참고 자료

- [Quantitative Trading 백테스팅 가이드](https://www.quantstart.com/)
- [Common Backtesting Mistakes](https://papers.ssrn.com/)

### 문의 및 피드백

백테스팅 관련 질문이나 개선 제안은 이슈로 남겨주세요.

---

**중요:** 백테스팅은 과거 데이터 기반 시뮬레이션입니다. 실제 투자 결과는 다를 수 있으며, 모든 투자 결정은 본인의 책임입니다.

